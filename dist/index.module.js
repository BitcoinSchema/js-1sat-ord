import{Script as t,Transaction as r,TxIn as n,P2PKHAddress as e,TxOut as o,SigHash as i}from"bsv-wasm";import{Buffer as s}from"buffer";import a from"fs";import u from"path";import c from"os";import{Sigma as l}from"sigma-protocol";function _(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=new Array(r);n<r;n++)e[n]=t[n];return e}function g(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return _(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}const p=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function f(t){console.log(`[dotenv@16.0.3][DEBUG] ${t}`)}const d={config:function(t){let r=u.resolve(process.cwd(),".env"),n="utf8";const e=Boolean(t&&t.debug),o=Boolean(t&&t.override);var i;t&&(null!=t.path&&(r="~"===(i=t.path)[0]?u.join(c.homedir(),i.slice(1)):i),null!=t.encoding&&(n=t.encoding));try{const t=d.parse(a.readFileSync(r,{encoding:n}));return Object.keys(t).forEach(function(r){Object.prototype.hasOwnProperty.call(process.env,r)?(!0===o&&(process.env[r]=t[r]),e&&f(!0===o?`"${r}" is already defined in \`process.env\` and WAS overwritten`:`"${r}" is already defined in \`process.env\` and was NOT overwritten`)):process.env[r]=t[r]}),{parsed:t}}catch(t){return e&&f(`Failed to load ${r} ${t.message}`),{error:t}}},parse:function(t){const r={};let n,e=t.toString();for(e=e.replace(/\r\n?/gm,"\n");null!=(n=p.exec(e));){const t=n[1];let e=n[2]||"";e=e.trim();const o=e[0];e=e.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===o&&(e=e.replace(/\\n/g,"\n"),e=e.replace(/\\r/g,"\r")),r[t]=e}return r}};var v=d.config,m=d.parse,h=d;h.config=v,h.parse=m;var y=function(t){for(var r=[],n=0,e=t.length;n<e;n++){var o=Number(t.charCodeAt(n)).toString(16);r.push(o)}return r.join("")};v();var w=function(r,n,e,o){var i="";if(void 0!==n&&void 0!==e){var a=y("ord"),u=s.from(n,"base64").toString("hex");i="OP_0 OP_IF "+a+" OP_1 "+y(e)+" OP_0 "+u+" OP_ENDIF"}var c=r.get_locking_script().to_asm_string()+(i?" "+i:"");if(o&&null!=o&&o.app&&null!=o&&o.type){c=c+" OP_RETURN "+y("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+y("SET");for(var l=0,_=Object.entries(o);l<_.length;l++){var g=_[l],p=g[0],f=g[1];"cmd"!==p&&(c=c+" "+y(p)+" "+y(f))}}return t.from_asm_string(c)},x=function(i,a,u,c){try{var l=new r(1,0),_=new n(s.from(i.txid,"hex"),i.vout,t.from_asm_string(i.script));l.add_input(_);var g=w(e.from_string(a),null==u?void 0:u.dataB64,null==u?void 0:u.contentType,c),p=new o(BigInt(1),g);return l.add_output(p),Promise.resolve(l)}catch(t){return Promise.reject(t)}},I=function(a,u,c,_,p,f,d,v,m){void 0===m&&(m=[]);try{var h=function(r){var n=y.sign(c,i.ALL|i.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));return x.set_unlocking_script(t.from_asm_string(n.to_hex()+" "+c.to_public_key().to_hex())),y.set_input(0,x),y},y=new r(1,0),x=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));y.add_input(x);var I=w(e.from_string(u),f.dataB64,f.contentType,d),b=new o(BigInt(1),I);y.add_output(b);for(var k,O=g(m);!(k=O()).done;){var S=k.value,j=new o(S.amount,e.from_string(S.to).get_locking_script());y.add_output(j)}for(var A,T=0n,$=y.get_noutputs(),E=g(Array($).keys());!(A=E()).done;){var F;T+=(null==(F=y.get_output(A.value))?void 0:F.get_satoshis())||0n}var K=e.from_string(_).get_locking_script(),M=Math.ceil(p*(y.get_size()+P+B)),R=BigInt(a.satoshis)-T-BigInt(M);if(R<0)throw new Error("Inadequate satoshis for fee");if(R>0){var U=new o(BigInt(R),K);y.add_output(U)}var N=null==v?void 0:v.idKey,C=null==v?void 0:v.keyHost,D=function(){if(!N)return function(){if(C){var t=null==v?void 0:v.authToken,r=new l(y);return function(n,e){try{var o=Promise.resolve(r.remoteSign(C,t)).then(function(t){y=t.signedTx})}catch(t){return e(t)}return o&&o.then?o.then(void 0,e):o}(0,function(t){throw console.log(t),new Error("Remote signing to "+C+" failed")})}}();var t=new l(y).sign(N);y=t.signedTx}();return Promise.resolve(D&&D.then?D.then(h):h())}catch(t){return Promise.reject(t)}},b=function(a,u,c,l,_,p,f,d,v,m){void 0===m&&(m=[]);try{var h=new r(1,0),y=new n(s.from(u.txid,"hex"),u.vout,t.from_asm_string(""));h.add_input(y);var x,I=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));h.add_input(I);var b=e.from_string(f);x=null!=d&&d.dataB64&&null!=d&&d.contentType?w(b,d.dataB64,d.contentType,v):b.get_locking_script();var k=new o(BigInt(1),x);h.add_output(k);for(var O,S=g(m);!(O=S()).done;){var j=O.value,A=new o(j.amount,e.from_string(j.to).get_locking_script());h.add_output(A)}for(var T,$=0n,E=h.get_noutputs(),F=g(Array(E).keys());!(T=F()).done;){var K;$+=(null==(K=h.get_output(T.value))?void 0:K.get_satoshis())||0n}var M=e.from_string(l).get_locking_script(),R=Math.ceil(_*(h.get_size()+P+2*B)),U=BigInt(a.satoshis)-$-BigInt(R),N=new o(U,M);h.add_output(N);var C=h.sign(p,i.InputOutput,0,t.from_asm_string(u.script),BigInt(u.satoshis));y.set_unlocking_script(t.from_asm_string(C.to_hex()+" "+p.to_public_key().to_hex())),h.set_input(0,y);var D=h.sign(c,i.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return I.set_unlocking_script(t.from_asm_string(D.to_hex()+" "+c.to_public_key().to_hex())),h.set_input(1,I),Promise.resolve(h)}catch(t){return Promise.reject(t)}},k=function(e,a,u,c){try{for(var l,_=new r(1,0),p=0,f=g(e||[]);!(l=f()).done;)p+=l.value.satoshis;var d=p-c;console.log({feeSats:c,satsIn:p,satsOut:d}),_.add_output(new o(BigInt(d),u.get_locking_script()));for(var v,m=0,h=g(e||[]);!(v=h()).done;){var y=v.value;console.log({u:y});var w=new n(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:w}),w.set_satoshis(BigInt(y.satoshis)),_.add_input(w);var x=_.sign(a,i.InputOutputs,m,t.from_asm_string(y.script),BigInt(y.satoshis));w.set_unlocking_script(t.from_asm_string(x.to_hex()+" "+a.to_public_key().to_hex())),_.set_input(m,w),m++}return Promise.resolve(_)}catch(t){return Promise.reject(t)}},B=107,O=148,P=34;export{O as P2PKH_FULL_INPUT_SIZE,B as P2PKH_INPUT_SCRIPT_SIZE,P as P2PKH_OUTPUT_SIZE,w as buildInscription,x as buildReinscriptionTemplate,I as createOrdinal,b as sendOrdinal,k as sendUtxos};
//# sourceMappingURL=index.module.js.map
