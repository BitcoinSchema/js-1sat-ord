import{Script as t,SigHash as r,Transaction as n,TxIn as e,P2PKHAddress as o,TxOut as i}from"bsv-wasm";import{Buffer as s}from"buffer";import*as a from"dotenv";import{Sigma as u}from"sigma-protocol";function _(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=new Array(r);n<r;n++)e[n]=t[n];return e}function c(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return _(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var g=function(t){for(var r=[],n=0,e=t.length;n<e;n++){var o=Number(t.charCodeAt(n)).toString(16);r.push(o)}return r.join("")};a.config();var m=function(r,n,e,o){var i=g("ord"),a=s.from(n,"base64").toString("hex"),u=g(e),_=r.get_locking_script().to_asm_string()+" OP_0 OP_IF "+i+" OP_1 "+u+" OP_0 "+a+" OP_ENDIF";if(o&&null!=o&&o.app&&null!=o&&o.type){_=_+" OP_RETURN "+g("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+g("SET");for(var c=0,m=Object.entries(o);c<m.length;c++){var f=m[c],l=f[0],p=f[1];"cmd"!==l&&(_=_+" "+g(l)+" "+g(p))}}return t.from_asm_string(_)},f=function(a,_,c,g,f,l,p,v){try{var h=function(n){var e=d.sign(c,r.ALL|r.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));return y.set_unlocking_script(t.from_asm_string(e.to_hex()+" "+c.to_public_key().to_hex())),d.set_input(0,y),d},d=new n(1,0),y=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));d.add_input(y);var b=m(o.from_string(_),l.dataB64,l.contentType,p),w=new i(BigInt(1),b);d.add_output(w);var I=o.from_string(g).get_locking_script(),x=new i(BigInt(1),I),k=Math.ceil(f*(d.get_size()+x.to_bytes().byteLength)),B=a.satoshis-1-k;if(B<0)throw new Error("Inadequate satoshis for fee");if(B>0){var O=new i(BigInt(B),I);d.add_output(O)}var P=null==v?void 0:v.idKey,S=null==v?void 0:v.keyHost,T=function(){if(!P)return function(){if(S){var t=null==v?void 0:v.authToken,r=new u(d);return function(n,e){try{var o=Promise.resolve(r.remoteSign(S,t)).then(function(t){d=t.signedTx})}catch(t){return e(t)}return o&&o.then?o.then(void 0,e):o}(0,function(t){throw console.log(t),new Error("Remote signing to "+S+" failed")})}}();var t=new u(d).sign(P);d=t.signedTx}();return Promise.resolve(T&&T.then?T.then(h):h())}catch(t){return Promise.reject(t)}},l=function(a,u,_,c,g,f,l,p,v){try{var h=new n(1,0),d=new e(s.from(u.txid,"hex"),u.vout,t.from_asm_string(""));h.add_input(d);var y,b=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));h.add_input(b);var w=o.from_string(l);y=null!=p&&p.dataB64&&null!=p&&p.contentType?m(w,p.dataB64,p.contentType,v):w.get_locking_script();var I=new i(BigInt(1),y);h.add_output(I);var x=o.from_string(c).get_locking_script(),k=new i(BigInt(1),x),B=Math.ceil(g*(h.get_size()+k.to_bytes().byteLength)),O=new i(BigInt(a.satoshis-B),x);h.add_output(O);var P=h.sign(f,r.InputOutput,0,t.from_asm_string(u.script),BigInt(u.satoshis));d.set_unlocking_script(t.from_asm_string(P.to_hex()+" "+f.to_public_key().to_hex())),h.set_input(0,d);var S=h.sign(_,r.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return b.set_unlocking_script(t.from_asm_string(S.to_hex()+" "+_.to_public_key().to_hex())),h.set_input(1,b),Promise.resolve(h)}catch(t){return Promise.reject(t)}},p=function(o,a,u,_){try{for(var g,m=new n(1,0),f=0,l=c(o||[]);!(g=l()).done;)f+=g.value.satoshis;var p=f-_;console.log({feeSats:_,satsIn:f,satsOut:p}),m.add_output(new i(BigInt(p),u.get_locking_script()));for(var v,h=0,d=c(o||[]);!(v=d()).done;){var y=v.value;console.log({u:y});var b=new e(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:b}),b.set_satoshis(BigInt(y.satoshis)),m.add_input(b);var w=m.sign(a,r.InputOutputs,h,t.from_asm_string(y.script),BigInt(y.satoshis));b.set_unlocking_script(t.from_asm_string(w.to_hex()+" "+a.to_public_key().to_hex())),m.set_input(h,b),h++}return Promise.resolve(m)}catch(t){return Promise.reject(t)}};export{m as buildInscription,f as createOrdinal,l as sendOrdinal,p as sendUtxos};
//# sourceMappingURL=index.module.js.map
