import{P2PKH as n,LockingScript as r,fromUtxo as t,SatoshisPerKilobyte as e,Transaction as o}from"@bsv/sdk";import{Sigma as i}from"sigma-protocol";function a(n,r){(null==r||r>n.length)&&(r=n.length);for(var t=0,e=Array(r);t<r;t++)e[t]=n[t];return e}function u(n,r){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(t)return(t=t.call(n)).next.bind(t);if(Array.isArray(n)||(t=function(n,r){if(n){if("string"==typeof n)return a(n,r);var t={}.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?a(n,r):void 0}}(n))||r&&n&&"number"==typeof n.length){t&&(n=t);var e=0;return function(){return e>=n.length?{done:!0}:{done:!1,value:n[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function s(){return s=Object.assign?Object.assign.bind():function(n){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var e in t)({}).hasOwnProperty.call(t,e)&&(n[e]=t[e])}return n},s.apply(null,arguments)}function c(n,r){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},c(n,r)}var f=function(n){return Buffer.from(n).toString("hex")},l=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}var o,i;return i=t,(o=e).prototype=Object.create(i.prototype),o.prototype.constructor=o,c(o,i),e.prototype.lock=function(t,e,o,i){var a="";if(void 0!==e&&void 0!==o){var u=f("ord"),s=Buffer.from(e,"base64").toString("hex").trim();if(!s)throw new Error("Invalid file data");var c=f(o);if(!c)throw new Error("Invalid media type");a="OP_0 OP_IF "+u+" OP_1 "+c+" OP_0 "+s+" OP_ENDIF"}var l=(a?a+" ":"")+(new n).lock(t).toASM();if(i&&(!i.app||!i.type))throw new Error("MAP.app and MAP.type are required fields");if(null!=i&&i.app&&null!=i&&i.type){l=l+" OP_RETURN "+f("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+f("SET");for(var d=0,v=Object.entries(i);d<v.length;d++){var h=v[d],p=h[0],m=h[1];"cmd"!==p&&(l=l+" "+f(p)+" "+f(m))}}return r.fromASM(l)},e}(n),d=function(n,r){var e=t(s({},n,{script:Buffer.from(n.script,"base64").toString("hex")}),r);return e.sourceTXID=n.txid,e},v=function(n,r){try{var t,e=function(n){if(t)return n;throw new Error("Signer must be a LocalSigner or RemoteSigner")},o=null==r?void 0:r.idKey,a=null==r?void 0:r.keyHost;if(o){var u=new i(n).sign(o);return Promise.resolve(u.signedTx)}var s=function(){if(a){var e=null==r?void 0:r.authToken,o=new i(n);return function(n,r){try{var i=Promise.resolve(o.remoteSign(a,e)).then(function(n){return t=1,n.signedTx})}catch(n){return r(n)}return i&&i.then?i.then(void 0,r):i}(0,function(n){throw console.log(n),new Error("Remote signing to "+a+" failed")})}}();return Promise.resolve(s&&s.then?s.then(e):e(s))}catch(n){return Promise.reject(n)}},h=function(r,t,i,a,s,c,f,h){void 0===s&&(s=10),void 0===h&&(h=[]);try{for(var p,m=function(){return Promise.resolve(w.fee(g)).then(function(){return Promise.resolve(w.sign()).then(function(){return w})})},g=new e(s),w=new o,y=u(r);!(p=y()).done;){var b=d(p.value,(new n).unlock(i));w.addInput(b)}t.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var S,P=u(t);!(S=P()).done;){var k=S.value;if(!k.inscription)throw new Error("Inscription is required for all destinations");w.addOutput({satoshis:1,lockingScript:(new l).lock(k.address,k.inscription.dataB64,k.inscription.contentType,c)})}for(var O,I=u(h);!(O=I()).done;){var E=O.value;w.addOutput({satoshis:E.amount,lockingScript:(new n).lock(E.to)})}w.addOutput({lockingScript:(new n).lock(a||i.toAddress().toString()),change:!0});var A=function(){if(f)return Promise.resolve(v(w,f)).then(function(n){w=n})}();return Promise.resolve(A&&A.then?A.then(m):m())}catch(n){return Promise.reject(n)}},p=function(r,t,i,a,s,c,f,h,p,m,g){void 0===f&&(f=10),void 0===m&&(m=[]),void 0===g&&(g=!0);try{for(var w,y=function(){return Promise.resolve(S.fee(b)).then(function(){return Promise.resolve(S.sign()).then(function(){return S})})},b=new e(f),S=new o,P=u(t);!(w=P()).done;){var k=w.value;if(1!==k.satoshis)throw new Error("1Sat Ordinal utxos must have exactly 1 satoshi");var O=d(k,(new l).unlock(a));S.addInput(O)}if(g&&s.length!==t.length)throw new Error("Number of destinations must match number of ordinals being sent");for(var I,E=u(s);!(I=E()).done;){var A,B,j,T=I.value;j=null!=(A=T.inscription)&&A.dataB64&&null!=(B=T.inscription)&&B.contentType?(new l).lock(T.address,T.inscription.dataB64,T.inscription.contentType,h):(new n).lock(T.address),S.addOutput({satoshis:1,lockingScript:j})}for(var x,_=u(m);!(x=_()).done;){var M=x.value;console.log("Additional payment",M),S.addOutput({satoshis:M.amount,lockingScript:(new n).lock(M.to)})}for(var N,R=u(r);!(N=R()).done;){var C=d(N.value,(new n).unlock(i));S.addInput(C)}var F=(new n).lock(c||i.toAddress().toString());S.addOutput({lockingScript:F,change:!0});var K=function(){if(p)return Promise.resolve(v(S,p)).then(function(n){S=n})}();return Promise.resolve(K&&K.then?K.then(y):y())}catch(n){return Promise.reject(n)}};const m="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function g(n,r,t){if(!n.s){if(t instanceof w){if(!t.s)return void(t.o=g.bind(null,n,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(g.bind(null,n,r),g.bind(null,n,2));n.s=r,n.v=t;var e=n.o;e&&e(n)}}var w=/*#__PURE__*/function(){function n(){}return n.prototype.then=function(r,t){var e=new n,o=this.s;if(o){var i=1&o?r:t;if(i){try{g(e,1,i(this.v))}catch(n){g(e,2,n)}return e}return this}return this.o=function(n){try{var o=n.v;1&n.s?g(e,1,r?r(o):o):t?g(e,1,t(o)):g(e,2,o)}catch(n){g(e,2,n)}},e},n}();function y(n){return n instanceof w&&1&n.s}var b,S=function(r,t,i,a){void 0===a&&(a=10);try{for(var s,c,f=function(){if(S<P+k)throw new Error("Not enough funds to deploy token. Total sats in: "+S+", Total sats out: "+P+", Fee: "+k);if(S>P+k){var r=t.toAddress().toString(),e=(new n).lock(r);v.addOutput({lockingScript:e,change:!0})}else S<P+k&&console.log("No change needed");return Promise.resolve(v.fee(l)).then(function(){return Promise.resolve(v.sign()).then(function(){return v})})},l=new e(a),v=new o,h=u(i);!(c=h()).done;){var p=c.value,b={satoshis:p.amount,lockingScript:(new n).lock(p.to)};v.addOutput(b)}var S=0n,P=v.outputs.reduce(function(n,r){return n+(r.satoshis||0)},0),k=0,O=function(n,r,t){if("function"==typeof n[m]){var e,o,i,a=n[m]();if(function n(u){try{for(;!((e=a.next()).done||t&&t());)if((u=r(e.value))&&u.then){if(!y(u))return void u.then(n,i||(i=g.bind(null,o=new w,2)));u=u.v}o?g(o,1,u):o=u}catch(n){g(o||(o=new w),2,n)}}(),a.return){var u=function(n){try{e.done||a.return()}catch(n){}return n};if(o&&o.then)return o.then(u,function(n){throw u(n)});u()}return o}if(!("length"in n))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<n.length;c++)s.push(n[c]);return function(n,r,t){var e,o,i=-1;return function a(u){try{for(;++i<n.length&&(!t||!t());)if((u=r(i))&&u.then){if(!y(u))return void u.then(a,o||(o=g.bind(null,e=new w,2)));u=u.v}e?g(e,1,u):e=u}catch(n){g(e||(e=new w),2,n)}}(),e}(s,function(n){return r(s[n])},t)}(r,function(r){var e=d(r,(new n).unlock(t));return v.addInput(e),S+=BigInt(r.satoshis),Promise.resolve(l.computeFee(v)).then(function(n){S>=P+(k=n)&&(s=1)})},function(){return s});return Promise.resolve(O&&O.then?O.then(f):f())}catch(n){return Promise.reject(n)}};!function(n){n.BSV20="bsv20",n.BSV21="bsv21"}(b||(b={}));var P=function(n,r,t,e,o,i,a,c,f,l,d,v,h){void 0===l&&(l=10),void 0===h&&(h=[]);try{var m=0n,g=0n,w=0n;if(!e.every(function(n){return n.id===r}))throw new Error("Input tokens do not match the provided tokenID");for(var y,S=u(e);!(y=S()).done;)g+=BigInt(y.value.amt);for(var P,k=u(o);!(P=k()).done;)w+=BigInt(P.value.amt);if(g<w)throw new Error("Not enough tokens to send");if((m=g-w)>0n){var O={address:f||a.toAddress().toString(),amt:m.toString()};o.push(O)}var I=o.map(function(t){var e,o={p:"bsv-20",op:"transfer",amt:t.amt};if(n===b.BSV20)e=s({},o,{tick:r});else{if(n!==b.BSV21)throw new Error("Invalid protocol");e=s({},o,{id:r})}return{address:t.address,inscription:{dataB64:Buffer.from(JSON.stringify(e)).toString("base64"),contentType:"application/bsv-20"}}});return Promise.resolve(p(t,e,i,a,I,c||i.toAddress().toString(),l,d,v,h,!1))}catch(n){return Promise.reject(n)}};export{h as createOrdinals,p as sendOrdinals,S as sendUtxos,P as transferOrdTokens};
//# sourceMappingURL=index.module.js.map
