import{Script as t,Transaction as r,TxIn as n,P2PKHAddress as e,TxOut as o,SigHash as i}from"bsv-wasm";import{Buffer as s}from"buffer";import*as a from"dotenv";import{Sigma as _}from"sigma-protocol";function u(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=new Array(r);n<r;n++)e[n]=t[n];return e}function g(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return u(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c=function(t){for(var r=[],n=0,e=t.length;n<e;n++){var o=Number(t.charCodeAt(n)).toString(16);r.push(o)}return r.join("")};a.config();var m=function(r,n,e,o){var i=c("ord"),a=s.from(n,"base64").toString("hex"),_=c(e),u=r.get_locking_script().to_asm_string()+" OP_0 OP_IF "+i+" OP_1 "+_+" OP_0 "+a+" OP_ENDIF";if(o&&null!=o&&o.app&&null!=o&&o.type){u=u+" OP_RETURN "+c("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+c("SET");for(var g=0,m=Object.entries(o);g<m.length;g++){var f=m[g],p=f[0],l=f[1];"cmd"!==p&&(u=u+" "+c(p)+" "+c(l))}}return t.from_asm_string(u)},f=function(a,u,g,c,f,p,l,v){try{var d=new r(1,0),h=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));d.add_input(h);var y=m(e.from_string(u),p.dataB64,p.contentType,l),b=new o(BigInt(1),y);d.add_output(b);var I=e.from_string(c).get_locking_script(),w=new o(BigInt(1),I),x=Math.ceil(f*(d.get_size()+w.to_bytes().byteLength)),B=a.satoshis-1-x;if(B<0)throw new Error("Inadequate satoshis for fee");if(B>0){var k=new o(BigInt(B),I);d.add_output(k)}var O=d.sign(g,i.ALL|i.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));return h.set_unlocking_script(t.from_asm_string(O.to_hex()+" "+g.to_public_key().to_hex())),d.set_input(0,h),v&&(d=new _(d).sign(v).signedTx),Promise.resolve(d)}catch(t){return Promise.reject(t)}},p=function(a,_,u,g,c,f,p,l,v){try{var d=new r(1,0),h=new n(s.from(_.txid,"hex"),_.vout,t.from_asm_string(""));d.add_input(h);var y,b=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));d.add_input(b);var I=e.from_string(p);y=null!=l&&l.dataB64&&null!=l&&l.contentType?m(I,l.dataB64,l.contentType,v):I.get_locking_script();var w=new o(BigInt(1),y);d.add_output(w);var x=e.from_string(g).get_locking_script(),B=new o(BigInt(1),x),k=Math.ceil(c*(d.get_size()+B.to_bytes().byteLength)),O=new o(BigInt(a.satoshis-k),x);d.add_output(O);var P=d.sign(f,i.InputOutput,0,t.from_asm_string(_.script),BigInt(_.satoshis));h.set_unlocking_script(t.from_asm_string(P.to_hex()+" "+f.to_public_key().to_hex())),d.set_input(0,h);var S=d.sign(u,i.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return b.set_unlocking_script(t.from_asm_string(S.to_hex()+" "+u.to_public_key().to_hex())),d.set_input(1,b),Promise.resolve(d)}catch(t){return Promise.reject(t)}},l=function(e,a,_,u){try{for(var c,m=new r(1,0),f=0,p=g(e||[]);!(c=p()).done;)f+=c.value.satoshis;var l=f-u;console.log({feeSats:u,satsIn:f,satsOut:l}),m.add_output(new o(BigInt(l),_.get_locking_script()));for(var v,d=0,h=g(e||[]);!(v=h()).done;){var y=v.value;console.log({u:y});var b=new n(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:b}),b.set_satoshis(BigInt(y.satoshis)),m.add_input(b);var I=m.sign(a,i.InputOutputs,d,t.from_asm_string(y.script),BigInt(y.satoshis));b.set_unlocking_script(t.from_asm_string(I.to_hex()+" "+a.to_public_key().to_hex())),m.set_input(d,b),d++}return Promise.resolve(m)}catch(t){return Promise.reject(t)}};export{m as buildInscription,f as createOrdinal,p as sendOrdinal,l as sendUtxos};
//# sourceMappingURL=index.module.js.map
