import{Script as t,Transaction as r,TxIn as n,P2PKHAddress as e,TxOut as o,SigHash as i}from"bsv-wasm";import{Buffer as s}from"buffer";import*as a from"dotenv";import{Sigma as u}from"sigma-protocol";function _(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=new Array(r);n<r;n++)e[n]=t[n];return e}function c(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return _(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var g=function(t){for(var r=[],n=0,e=t.length;n<e;n++){var o=Number(t.charCodeAt(n)).toString(16);r.push(o)}return r.join("")};a.config();var m=function(r,n,e,o){var i="";if(void 0!==n&&void 0!==e){var a=g("ord"),u=s.from(n,"base64").toString("hex");i="OP_0 OP_IF "+a+" OP_1 "+g(e)+" OP_0 "+u+" OP_ENDIF"}var _=r.get_locking_script().to_asm_string()+(i?" "+i:"");if(o&&null!=o&&o.app&&null!=o&&o.type){_=_+" OP_RETURN "+g("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+g("SET");for(var c=0,m=Object.entries(o);c<m.length;c++){var f=m[c],l=f[0],v=f[1];"cmd"!==l&&(_=_+" "+g(l)+" "+g(v))}}return t.from_asm_string(_)},f=function(i,a,u,_){try{var c=new r(1,0),g=new n(s.from(i.txid,"hex"),i.vout,t.from_asm_string(i.script));c.add_input(g);var f=m(e.from_string(a),null==u?void 0:u.dataB64,null==u?void 0:u.contentType,_),l=new o(BigInt(1),f);return c.add_output(l),Promise.resolve(c)}catch(t){return Promise.reject(t)}},l=function(a,_,c,g,f,l,v,p){try{var d=function(r){var n=h.sign(c,i.ALL|i.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));return y.set_unlocking_script(t.from_asm_string(n.to_hex()+" "+c.to_public_key().to_hex())),h.set_input(0,y),h},h=new r(1,0),y=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));h.add_input(y);var w=m(e.from_string(_),l.dataB64,l.contentType,v),b=new o(BigInt(1),w);h.add_output(b);var x=e.from_string(g).get_locking_script(),I=new o(BigInt(1),x),B=Math.ceil(f*(h.get_size()+I.to_bytes().byteLength)),k=a.satoshis-1-B;if(k<0)throw new Error("Inadequate satoshis for fee");if(k>0){var P=new o(BigInt(k),x);h.add_output(P)}var O=null==p?void 0:p.idKey,S=null==p?void 0:p.keyHost,T=function(){if(!O)return function(){if(S){var t=null==p?void 0:p.authToken,r=new u(h);return function(n,e){try{var o=Promise.resolve(r.remoteSign(S,t)).then(function(t){h=t.signedTx})}catch(t){return e(t)}return o&&o.then?o.then(void 0,e):o}(0,function(t){throw console.log(t),new Error("Remote signing to "+S+" failed")})}}();var t=new u(h).sign(O);h=t.signedTx}();return Promise.resolve(T&&T.then?T.then(d):d())}catch(t){return Promise.reject(t)}},v=function(a,u,_,c,g,f,l,v,p){try{var d=new r(1,0),h=new n(s.from(u.txid,"hex"),u.vout,t.from_asm_string(""));d.add_input(h);var y,w=new n(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));d.add_input(w);var b=e.from_string(l);y=null!=v&&v.dataB64&&null!=v&&v.contentType?m(b,v.dataB64,v.contentType,p):b.get_locking_script();var x=new o(BigInt(1),y);d.add_output(x);var I=e.from_string(c).get_locking_script(),B=new o(BigInt(1),I),k=Math.ceil(g*(d.get_size()+B.to_bytes().byteLength)),P=new o(BigInt(a.satoshis-k),I);d.add_output(P);var O=d.sign(f,i.InputOutput,0,t.from_asm_string(u.script),BigInt(u.satoshis));h.set_unlocking_script(t.from_asm_string(O.to_hex()+" "+f.to_public_key().to_hex())),d.set_input(0,h);var S=d.sign(_,i.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return w.set_unlocking_script(t.from_asm_string(S.to_hex()+" "+_.to_public_key().to_hex())),d.set_input(1,w),Promise.resolve(d)}catch(t){return Promise.reject(t)}},p=function(e,a,u,_){try{for(var g,m=new r(1,0),f=0,l=c(e||[]);!(g=l()).done;)f+=g.value.satoshis;var v=f-_;console.log({feeSats:_,satsIn:f,satsOut:v}),m.add_output(new o(BigInt(v),u.get_locking_script()));for(var p,d=0,h=c(e||[]);!(p=h()).done;){var y=p.value;console.log({u:y});var w=new n(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:w}),w.set_satoshis(BigInt(y.satoshis)),m.add_input(w);var b=m.sign(a,i.InputOutputs,d,t.from_asm_string(y.script),BigInt(y.satoshis));w.set_unlocking_script(t.from_asm_string(b.to_hex()+" "+a.to_public_key().to_hex())),m.set_input(d,w),d++}return Promise.resolve(m)}catch(t){return Promise.reject(t)}};export{m as buildInscription,l as createOrdinal,f as reinscribeOrdinalTemplate,v as sendOrdinal,p as sendUtxos};
//# sourceMappingURL=index.module.js.map
