import{P2PKH as r,LockingScript as t,fromUtxo as n,SatoshisPerKilobyte as e,Transaction as o}from"@bsv/sdk";import{Sigma as i}from"sigma-protocol";function a(r,t){(null==t||t>r.length)&&(t=r.length);for(var n=0,e=Array(t);n<t;n++)e[n]=r[n];return e}function s(r,t){var n="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(n)return(n=n.call(r)).next.bind(n);if(Array.isArray(r)||(n=function(r,t){if(r){if("string"==typeof r)return a(r,t);var n={}.toString.call(r).slice(8,-1);return"Object"===n&&r.constructor&&(n=r.constructor.name),"Map"===n||"Set"===n?Array.from(r):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(r,t):void 0}}(r))||t&&r&&"number"==typeof r.length){n&&(r=n);var e=0;return function(){return e>=r.length?{done:!0}:{done:!1,value:r[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function u(){return u=Object.assign?Object.assign.bind():function(r){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var e in n)({}).hasOwnProperty.call(n,e)&&(r[e]=n[e])}return r},u.apply(null,arguments)}function c(r,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,t){return r.__proto__=t,r},c(r,t)}var d,l=function(r){return Buffer.from(r).toString("hex")},f=/*#__PURE__*/function(n){function e(){return n.apply(this,arguments)||this}var o,i;return i=n,(o=e).prototype=Object.create(i.prototype),o.prototype.constructor=o,c(o,i),e.prototype.lock=function(n,e,o,i){var a="";if(void 0!==e&&void 0!==o){var s=l("ord"),u=Buffer.from(e,"base64").toString("hex").trim();if(!u)throw new Error("Invalid file data");var c=l(o);if(!c)throw new Error("Invalid media type");a="OP_0 OP_IF "+s+" OP_1 "+c+" OP_0 "+u+" OP_ENDIF"}var d=(a?a+" ":"")+(new r).lock(n).toASM();if(i&&(!i.app||!i.type))throw new Error("MAP.app and MAP.type are required fields");if(null!=i&&i.app&&null!=i&&i.type){d=d+" OP_RETURN "+l("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+l("SET");for(var f=0,v=Object.entries(i);f<v.length;f++){var p=v[f],h=p[0],m=p[1];"cmd"!==h&&(d=d+" "+l(h)+" "+l(m))}}return t.fromASM(d)},e}(r),v=function(r,t){var e=n(u({},r,{script:Buffer.from(r.script,"base64").toString("hex")}),t);return e.sourceTXID=r.txid,e},p=function(r,t){try{var n,e=function(r){if(n)return r;throw new Error("Signer must be a LocalSigner or RemoteSigner")},o=null==t?void 0:t.idKey,a=null==t?void 0:t.keyHost;if(o){var s=new i(r).sign(o);return Promise.resolve(s.signedTx)}var u=function(){if(a){var e=null==t?void 0:t.authToken,o=new i(r);return function(r,t){try{var i=Promise.resolve(o.remoteSign(a,e)).then(function(r){return n=1,r.signedTx})}catch(r){return t(r)}return i&&i.then?i.then(void 0,t):i}(0,function(r){throw console.log(r),new Error("Remote signing to "+a+" failed")})}}();return Promise.resolve(u&&u.then?u.then(e):e(u))}catch(r){return Promise.reject(r)}},h=function(t,n,i,a,u,c,d,l){void 0===u&&(u=10),void 0===l&&(l=[]);try{for(var h,m=function(){return Promise.resolve(w.fee(g)).then(function(){return Promise.resolve(w.sign()).then(function(){return w})})},g=new e(u),w=new o,y=s(t);!(h=y()).done;){var S=v(h.value,(new r).unlock(i));w.addInput(S)}n.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var b,k=s(n);!(b=k()).done;){var P=b.value;if(!P.inscription)throw new Error("Inscription is required for all destinations");w.addOutput({satoshis:1,lockingScript:(new f).lock(P.address,P.inscription.dataB64,P.inscription.contentType,c)})}for(var O,I=s(l);!(O=I()).done;){var A=O.value;w.addOutput({satoshis:A.amount,lockingScript:(new r).lock(A.to)})}w.addOutput({lockingScript:(new r).lock(a||i.toAddress().toString()),change:!0});var E=function(){if(d)return Promise.resolve(p(w,d)).then(function(r){w=r})}();return Promise.resolve(E&&E.then?E.then(m):m())}catch(r){return Promise.reject(r)}},m=function(t,n,i,a,u,c,d,l,h,m,g){void 0===d&&(d=10),void 0===m&&(m=[]),void 0===g&&(g=!0);try{for(var w,y=function(){return Promise.resolve(b.fee(S)).then(function(){return Promise.resolve(b.sign()).then(function(){return b})})},S=new e(d),b=new o,k=s(n);!(w=k()).done;){var P=w.value;if(1!==P.satoshis)throw new Error("1Sat Ordinal utxos must have exactly 1 satoshi");var O=v(P,(new f).unlock(a));b.addInput(O)}for(var I,A=s(t);!(I=A()).done;){var E=v(I.value,(new r).unlock(i));b.addInput(E)}if(g&&u.length!==n.length)throw new Error("Number of destinations must match number of ordinals being sent");for(var B,j=s(u);!(B=j()).done;){var T,x,_,M=B.value;_=null!=(T=M.inscription)&&T.dataB64&&null!=(x=M.inscription)&&x.contentType?(new f).lock(M.address,M.inscription.dataB64,M.inscription.contentType,l):(new r).lock(M.address),b.addOutput({satoshis:1,lockingScript:_})}for(var N,R=s(m);!(N=R()).done;){var C=N.value;console.log("Additional payment",C),b.addOutput({satoshis:C.amount,lockingScript:(new r).lock(C.to)})}var K=(new r).lock(c||i.toAddress().toString());b.addOutput({lockingScript:K,change:!0});var U=function(){if(h)return Promise.resolve(p(b,h)).then(function(r){b=r})}();return Promise.resolve(U&&U.then?U.then(y):y())}catch(r){return Promise.reject(r)}},g=function(t,n,i,a){void 0===a&&(a=10);try{for(var u,c=new e(a),d=new o,l=s(t);!(u=l()).done;){var f=v(u.value,(new r).unlock(n));d.addInput(f)}for(var p,h=s(i);!(p=h()).done;){var m=p.value,g={satoshis:m.amount,lockingScript:(new r).lock(m.to)};d.addOutput(g)}var w=n.toAddress().toString(),y=(new r).lock(w);return d.addOutput({lockingScript:y,change:!0}),Promise.resolve(d.fee(c)).then(function(){return Promise.resolve(d.sign()).then(function(){return d})})}catch(r){return Promise.reject(r)}};!function(r){r.BSV20="bsv20",r.BSV21="bsv21"}(d||(d={}));var w=function(r,t,n,e,o,i,a,c,l,f,v,p,h){void 0===f&&(f=10),void 0===h&&(h=[]);try{var g=0n,w=0n,y=0n;if(!e.every(function(r){return r.id===t}))throw new Error("Input tokens do not match the provided tokenID");for(var S,b=s(e);!(S=b()).done;)w+=BigInt(S.value.amt);for(var k,P=s(o);!(k=P()).done;)y+=BigInt(k.value.amt);if(w<y)throw new Error("Not enough tokens to send");if((g=w-y)>0n){var O={address:l||a.toAddress().toString(),amt:g.toString()};o.push(O)}var I=o.map(function(n){var e,o={p:"bsv-20",op:"transfer",amt:n.amt};if(r===d.BSV20)e=u({},o,{tick:t});else{if(r!==d.BSV21)throw new Error("Invalid protocol");e=u({},o,{id:t})}return{address:n.address,inscription:{dataB64:Buffer.from(JSON.stringify(e)).toString("base64"),contentType:"application/bsv-20"}}});return Promise.resolve(m(n,e,i,a,I,c||i.toAddress().toString(),f,v,p,h,!1))}catch(r){return Promise.reject(r)}};export{h as createOrdinals,m as sendOrdinals,g as sendUtxos,w as transferOrdTokens};
//# sourceMappingURL=index.module.js.map
