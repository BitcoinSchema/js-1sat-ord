import{Script as t,Transaction as r,TxIn as e,P2PKHAddress as n,TxOut as o,SigHash as i}from"bsv-wasm";import{Buffer as s}from"buffer";import a from"fs";import c from"path";import u from"os";import{Sigma as l}from"sigma-protocol";function _(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=new Array(r);e<r;e++)n[e]=t[e];return n}function g(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return _(t,r);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?_(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}const f=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function p(t){console.log(`[dotenv@16.0.3][DEBUG] ${t}`)}const m={config:function(t){let r=c.resolve(process.cwd(),".env"),e="utf8";const n=Boolean(t&&t.debug),o=Boolean(t&&t.override);var i;t&&(null!=t.path&&(r="~"===(i=t.path)[0]?c.join(u.homedir(),i.slice(1)):i),null!=t.encoding&&(e=t.encoding));try{const t=m.parse(a.readFileSync(r,{encoding:e}));return Object.keys(t).forEach(function(r){Object.prototype.hasOwnProperty.call(process.env,r)?(!0===o&&(process.env[r]=t[r]),n&&p(!0===o?`"${r}" is already defined in \`process.env\` and WAS overwritten`:`"${r}" is already defined in \`process.env\` and was NOT overwritten`)):process.env[r]=t[r]}),{parsed:t}}catch(t){return n&&p(`Failed to load ${r} ${t.message}`),{error:t}}},parse:function(t){const r={};let e,n=t.toString();for(n=n.replace(/\r\n?/gm,"\n");null!=(e=f.exec(n));){const t=e[1];let n=e[2]||"";n=n.trim();const o=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===o&&(n=n.replace(/\\n/g,"\n"),n=n.replace(/\\r/g,"\r")),r[t]=n}return r}};var d=m.config,v=m.parse,h=m;h.config=d,h.parse=v;var y=function(t){for(var r=[],e=0,n=t.length;e<n;e++){var o=Number(t.charCodeAt(e)).toString(16);r.push(o)}return r.join("")};d();var w=function(r,e,n,o){var i="";if(void 0!==e&&void 0!==n){var a=y("ord"),c=s.from(e,"base64").toString("hex");i="OP_0 OP_IF "+a+" OP_1 "+y(n)+" OP_0 "+c+" OP_ENDIF"}var u=r.get_locking_script().to_asm_string()+(i?" "+i:"");if(o&&null!=o&&o.app&&null!=o&&o.type){u=u+" OP_RETURN "+y("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+y("SET");for(var l=0,_=Object.entries(o);l<_.length;l++){var g=_[l],f=g[0],p=g[1];"cmd"!==f&&(u=u+" "+y(f)+" "+y(p))}}return t.from_asm_string(u)},b=function(i,a,c,u){try{var l=new r(1,0),_=new e(s.from(i.txid,"hex"),i.vout,t.from_asm_string(i.script));l.add_input(_);var g=w(n.from_string(a),null==c?void 0:c.dataB64,null==c?void 0:c.contentType,u),f=new o(BigInt(1),g);return l.add_output(f),Promise.resolve(l)}catch(t){return Promise.reject(t)}},x=function(a,c,u,_,g,f,p,m){try{var d=function(r){var e=v.sign(u,i.ALL|i.FORKID,0,t.from_asm_string(a.script),BigInt(a.satoshis));return h.set_unlocking_script(t.from_asm_string(e.to_hex()+" "+u.to_public_key().to_hex())),v.set_input(0,h),v},v=new r(1,0),h=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));v.add_input(h);var y=w(n.from_string(c),f.dataB64,f.contentType,p),b=new o(BigInt(1),y);v.add_output(b);var x=n.from_string(_).get_locking_script(),I=new o(BigInt(1),x),B=Math.ceil(g*(v.get_size()+I.to_bytes().byteLength)),O=a.satoshis-1-B;if(O<0)throw new Error("Inadequate satoshis for fee");if(O>0){var k=new o(BigInt(O),x);v.add_output(k)}var P=null==m?void 0:m.idKey,S=null==m?void 0:m.keyHost,j=function(){if(!P)return function(){if(S){var t=null==m?void 0:m.authToken,r=new l(v);return function(e,n){try{var o=Promise.resolve(r.remoteSign(S,t)).then(function(t){v=t.signedTx})}catch(t){return n(t)}return o&&o.then?o.then(void 0,n):o}(0,function(t){throw console.log(t),new Error("Remote signing to "+S+" failed")})}}();var t=new l(v).sign(P);v=t.signedTx}();return Promise.resolve(j&&j.then?j.then(d):d())}catch(t){return Promise.reject(t)}},I=function(a,c,u,l,_,g,f,p,m){try{var d=new r(1,0),v=new e(s.from(c.txid,"hex"),c.vout,t.from_asm_string(""));d.add_input(v);var h,y=new e(s.from(a.txid,"hex"),a.vout,t.from_asm_string(""));d.add_input(y);var b=n.from_string(f);h=null!=p&&p.dataB64&&null!=p&&p.contentType?w(b,p.dataB64,p.contentType,m):b.get_locking_script();var x=new o(BigInt(1),h);d.add_output(x);var I=n.from_string(l).get_locking_script(),B=new o(BigInt(1),I),O=Math.ceil(_*(d.get_size()+B.to_bytes().byteLength)),k=new o(BigInt(a.satoshis-O),I);d.add_output(k);var P=d.sign(g,i.InputOutput,0,t.from_asm_string(c.script),BigInt(c.satoshis));v.set_unlocking_script(t.from_asm_string(P.to_hex()+" "+g.to_public_key().to_hex())),d.set_input(0,v);var S=d.sign(u,i.InputOutput,1,t.from_asm_string(a.script),BigInt(a.satoshis));return y.set_unlocking_script(t.from_asm_string(S.to_hex()+" "+u.to_public_key().to_hex())),d.set_input(1,y),Promise.resolve(d)}catch(t){return Promise.reject(t)}},B=function(n,a,c,u){try{for(var l,_=new r(1,0),f=0,p=g(n||[]);!(l=p()).done;)f+=l.value.satoshis;var m=f-u;console.log({feeSats:u,satsIn:f,satsOut:m}),_.add_output(new o(BigInt(m),c.get_locking_script()));for(var d,v=0,h=g(n||[]);!(d=h()).done;){var y=d.value;console.log({u:y});var w=new e(s.from(y.txid,"hex"),y.vout,t.from_asm_string(""));console.log({inx:w}),w.set_satoshis(BigInt(y.satoshis)),_.add_input(w);var b=_.sign(a,i.InputOutputs,v,t.from_asm_string(y.script),BigInt(y.satoshis));w.set_unlocking_script(t.from_asm_string(b.to_hex()+" "+a.to_public_key().to_hex())),_.set_input(v,w),v++}return Promise.resolve(_)}catch(t){return Promise.reject(t)}};export{w as buildInscription,b as buildReinscriptionTemplate,x as createOrdinal,I as sendOrdinal,B as sendUtxos};
//# sourceMappingURL=index.module.js.map
