import{P2PKH as t,LockingScript as e,Script as r,Utils as n,fromUtxo as o,SatoshisPerKilobyte as i,Transaction as s,OP as a,BigNumber as u,UnlockingScript as c,TransactionSignature as f}from"@bsv/sdk";import{Sigma as d}from"sigma-protocol";function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function p(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return l(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?l(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function h(){return h=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)({}).hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},h.apply(null,arguments)}function v(t,e){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},v(t,e)}var m,g,y=function(t){return Buffer.from(t).toString("hex")},b=10,w="https://ordinals.gorillapool.io/api",x=/*#__PURE__*/function(r){function n(){return r.apply(this,arguments)||this}var o,i;return i=r,(o=n).prototype=Object.create(i.prototype),o.prototype.constructor=o,v(o,i),n.prototype.lock=function(r,n,o,i){var s="";if(void 0!==n&&void 0!==o){var a=y("ord"),u=Buffer.from(n,"base64").toString("hex").trim();if(!u)throw new Error("Invalid file data");var c=y(o);if(!c)throw new Error("Invalid media type");s="OP_0 OP_IF "+a+" OP_1 "+c+" OP_0 "+u+" OP_ENDIF"}var f=(s?s+" ":"")+(new t).lock(r).toASM();if(i&&(!i.app||!i.type))throw new Error("MAP.app and MAP.type are required fields");if(null!=i&&i.app&&null!=i&&i.type){f=f+" OP_RETURN "+y("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")+" "+y("SET");for(var d=0,l=Object.entries(i);d<l.length;d++){var p=l[d],h=p[0],v=p[1];"cmd"!==h&&(f=f+" "+y(h)+" "+y(v))}}return e.fromASM(f)},n}(t);!function(t){t.BSV20="bsv20",t.BSV21="bsv21"}(m||(m={})),function(t){t.Paymail="paymail",t.Address="address",t.Script="script"}(g||(g={}));var S=n.fromBase58Check,P=function(t,e){var r=o(h({},t,{script:Buffer.from(t.script,"base64").toString("hex")}),e);return r.sourceTXID=t.txid,r},k=function(e,r){void 0===r&&(r="base64");try{var n=w+"/txos/address/"+e+"/unspent?bsv20=false";return console.log({payUrl:n}),Promise.resolve(fetch(n)).then(function(n){if(!n.ok)throw new Error("Error fetching pay utxos");return Promise.resolve(n.json()).then(function(n){n=n.filter(function(t){return 1!==t.satoshis});var o=S(e),i=(new t).lock(o.data);return n.map(function(t){return{txid:t.txid,vout:t.vout,satoshis:t.satoshis,script:"hex"===r||"base64"===r?Buffer.from(i.toBinary()).toString(r):i.toASM()}})})})}catch(t){return Promise.reject(t)}},O=function(t,e,n,o,i){void 0===n&&(n=10),void 0===o&&(o=0),void 0===i&&(i="base64");try{var s=w+"/txos/address/"+t+"/unspent?limit="+n+"&offset="+o+"&";return e&&(s+="q="+Buffer.from(JSON.stringify({map:{subTypeData:{collectionId:e}}})).toString("base64")),Promise.resolve(fetch(s)).then(function(n){if(!n.ok)throw new Error("Error fetching NFT utxos for "+t);return Promise.resolve(n.json()).then(function(n){var o=(n=n.filter(function(t){var e;return 1===t.satoshis&&!(null!=(e=t.data)&&e.list)})).map(function(t){return t.txid+"_"+t.vout});return Promise.resolve(fetch(w+"/txos/outpoints?script=true",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([].concat(o))})).then(function(o){if(!o.ok)throw new Error("Error fetching NFT scripts for "+t);return Promise.resolve(o.json()).then(function(t){return n=t.map(function(t){var n=t.script;"hex"===i?n=Buffer.from(n,"base64").toString("hex"):"asm"===i&&(n=r.fromHex(Buffer.from(n,"base64").toString("hex")).toASM());var o={origin:t.origin.outpoint,script:n,vout:t.vout,txid:t.txid,satoshis:1};return e&&(o.collectionId=e),o})})})})})}catch(t){return Promise.reject(t)}},I=function(t,e,r){try{return Promise.resolve(fetch(w+"/bsv20/"+r+"/"+(t===m.BSV20?"tick":"id")+"/"+e+"?bsv20=true&listing=false")).then(function(r){if(!r.ok)throw new Error("Error fetching "+t+" utxos");return Promise.resolve(r.json()).then(function(t){return t.map(function(t){return{amt:t.amt,script:t.script,vout:t.vout,txid:t.txid,id:e,satoshis:1}})})})}catch(t){return Promise.reject(t)}},B=function(t,e){try{var r,n=function(t){if(r)return t;throw new Error("Signer must be a LocalSigner or RemoteSigner")},o=null==e?void 0:e.idKey,i=null==e?void 0:e.keyHost;if(o){var s=new d(t).sign(o);return Promise.resolve(s.signedTx)}var a=function(){if(i){var n=null==e?void 0:e.authToken,o=new d(t);return function(t,e){try{var s=Promise.resolve(o.remoteSign(i,n)).then(function(t){return r=1,t.signedTx})}catch(t){return e(t)}return s&&s.then?s.then(void 0,e):s}(0,function(t){throw console.log(t),new Error("Remote signing to "+i+" failed")})}}();return Promise.resolve(a&&a.then?a.then(n):n(a))}catch(t){return Promise.reject(t)}},A=function(t){if(t){for(var e={app:t.app,type:t.type},r=0,n=Object.entries(t);r<n.length;r++){var o=n[r],i=o[1];void 0!==i&&(e[o[0]]="string"==typeof i?i:Array.isArray(i)||"object"==typeof i?JSON.stringify(i):String(i))}return e}},E=function(e){try{for(var r,n=e.utxos,o=e.destinations,a=e.paymentPk,u=e.changeAddress,c=e.satsPerKb,f=e.metaData,d=e.signer,l=e.additionalPayments,h=void 0===l?[]:l,v=new i(void 0===c?b:c),m=new s,g=p(n);!(r=g()).done;){var y=P(r.value,(new t).unlock(a));m.addInput(y)}o.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var w,S=p(o);!(w=S()).done;){var k=w.value;if(!k.inscription)throw new Error("Inscription is required for all destinations");if(f)for(var O=0,I=Object.keys(f);O<I.length;O++){var E=I[O];void 0===f[E]&&delete f[E]}m.addOutput({satoshis:1,lockingScript:(new x).lock(k.address,k.inscription.dataB64,k.inscription.contentType,A(f))})}for(var j,C=p(h);!(j=C()).done;){var T=j.value;m.addOutput({satoshis:T.amount,lockingScript:(new t).lock(T.to)})}var _=n.reduce(function(t,e){return t+BigInt(e.satoshis)},0n),N=m.outputs.reduce(function(t,e){return t+BigInt(e.satoshis||0)},0n);return Promise.resolve(v.computeFee(m)).then(function(e){function r(){return Promise.resolve(m.fee(v)).then(function(){return Promise.resolve(m.sign()).then(function(){return o&&(o.satoshis=m.outputs[m.outputs.length-1].satoshis,o.txid=m.id("hex")),{tx:m,spentOutpoints:n.map(function(t){return t.txid+"_"+t.vout}),payChange:o}})})}var o;if(_>N+BigInt(e)){var i=(new t).lock(u||a.toAddress().toString()),s={lockingScript:i,change:!0};o={txid:"",vout:m.outputs.length,satoshis:0,script:Buffer.from(i.toHex(),"hex").toString("base64")},m.addOutput(s)}var c=function(){if(d)return Promise.resolve(B(m,d)).then(function(t){m=t})}();return c&&c.then?c.then(r):r()})}catch(t){return Promise.reject(t)}};const j="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function C(t,e,r){if(!t.s){if(r instanceof T){if(!r.s)return void(r.o=C.bind(null,t,e));1&e&&(e=r.s),r=r.v}if(r&&r.then)return void r.then(C.bind(null,t,e),C.bind(null,t,2));t.s=e,t.v=r;var n=t.o;n&&n(t)}}var T=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,r){var n=new t,o=this.s;if(o){var i=1&o?e:r;if(i){try{C(n,1,i(this.v))}catch(t){C(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?C(n,1,e?e(o):o):r?C(n,1,r(o)):C(n,2,o)}catch(t){C(n,2,t)}},n},t}();function _(t){return t instanceof T&&1&t.s}var N=function(e){try{var r,n=function(){function r(){return Promise.resolve(u.fee(a)).then(function(){return Promise.resolve(u.sign()).then(function(){return n&&(n.satoshis=u.outputs[u.outputs.length-1].satoshis,n.txid=u.id("hex")),{tx:u,spentOutpoints:c,payChange:n}})})}if(I<E)throw new Error("Not enough ordinals to send");var n;if(I>E+BigInt(N)){var o=(new t).lock(e.changeAddress||e.paymentPk.toAddress().toString()),i={lockingScript:o,change:!0};n={txid:"",vout:u.outputs.length,satoshis:0,script:Buffer.from(o.toHex(),"hex").toString("base64")},u.addOutput(i)}var s=function(){if(e.signer)return Promise.resolve(B(u,e.signer)).then(function(t){u=t})}();return s&&s.then?s.then(r):r()};e.satsPerKb||(e.satsPerKb=b),e.additionalPayments||(e.additionalPayments=[]),void 0===e.enforceUniformSend&&(e.enforceUniformSend=!0);for(var o,a=new i(e.satsPerKb),u=new s,c=[],f=p(e.ordinals);!(o=f()).done;){var d=o.value;if(1!==d.satoshis)throw new Error("1Sat Ordinal utxos must have exactly 1 satoshi");var l=P(d,(new x).unlock(e.ordPk));c.push(d.txid+"_"+d.vout),u.addInput(l)}if(e.enforceUniformSend&&e.destinations.length!==e.ordinals.length)throw new Error("Number of destinations must match number of ordinals being sent");for(var h,v=p(e.destinations);!(h=v()).done;){var m,g,y,w=h.value;y=null!=(m=w.inscription)&&m.dataB64&&null!=(g=w.inscription)&&g.contentType?(new x).lock(w.address,w.inscription.dataB64,w.inscription.contentType,A(e.metaData)):(new t).lock(w.address),u.addOutput({satoshis:1,lockingScript:y})}for(var S,k=p(e.additionalPayments);!(S=k()).done;){var O=S.value;u.addOutput({satoshis:O.amount,lockingScript:(new t).lock(O.to)})}var I=0n,E=u.outputs.reduce(function(t,e){return t+BigInt(e.satoshis||0)},0n),N=0,H=function(t,e,r){if("function"==typeof t[j]){var n,o,i,s=t[j]();if(function t(a){try{for(;!((n=s.next()).done||r&&r());)if((a=e(n.value))&&a.then){if(!_(a))return void a.then(t,i||(i=C.bind(null,o=new T,2)));a=a.v}o?C(o,1,a):o=a}catch(t){C(o||(o=new T),2,t)}}(),s.return){var a=function(t){try{n.done||s.return()}catch(t){}return t};if(o&&o.then)return o.then(a,function(t){throw a(t)});a()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<t.length;c++)u.push(t[c]);return function(t,e,r){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!r||!r());)if((a=e(i))&&a.then){if(!_(a))return void a.then(s,o||(o=C.bind(null,n=new T,2)));a=a.v}n?C(n,1,a):n=a}catch(t){C(n||(n=new T),2,t)}}(),n}(u,function(t){return e(u[t])},r)}(e.paymentUtxos,function(n){var o=P(n,(new t).unlock(e.paymentPk));return c.push(n.txid+"_"+n.vout),u.addInput(o),I+=BigInt(n.satoshis),Promise.resolve(a.computeFee(u)).then(function(t){N=t,I>=E+BigInt(N)&&(r=1)})},function(){return r});return Promise.resolve(H&&H.then?H.then(n):n())}catch(t){return Promise.reject(t)}};const H="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function L(t,e,r){if(!t.s){if(r instanceof K){if(!r.s)return void(r.o=L.bind(null,t,e));1&e&&(e=r.s),r=r.v}if(r&&r.then)return void r.then(L.bind(null,t,e),L.bind(null,t,2));t.s=e,t.v=r;var n=t.o;n&&n(t)}}var K=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,r){var n=new t,o=this.s;if(o){var i=1&o?e:r;if(i){try{L(n,1,i(this.v))}catch(t){L(n,2,t)}return n}return this}return this.o=function(t){try{var o=t.v;1&t.s?L(n,1,e?e(o):o):r?L(n,1,r(o)):L(n,2,o)}catch(t){L(n,2,t)}},n},t}();function U(t){return t instanceof K&&1&t.s}var q=function(e){try{for(var r,n,o=function(){if(x<S+k)throw new Error("Not enough funds to send. Total sats in: "+x+", Total sats out: "+S+", Fee: "+k);var e;if(x>S+k){var r=(new t).lock(h),n={lockingScript:r,change:!0};e={txid:"",vout:m.outputs.length,satoshis:0,script:Buffer.from(r.toHex(),"hex").toString("base64")},m.addOutput(n)}else x<S+k&&console.log("No change needed");return Promise.resolve(m.fee(v)).then(function(){return Promise.resolve(m.sign()).then(function(){return e&&(e.satoshis=m.outputs[m.outputs.length-1].satoshis,e.txid=m.id("hex")),{tx:m,spentOutpoints:a.map(function(t){return t.txid+"_"+t.vout}),payChange:e}})})},a=e.utxos,u=e.paymentPk,c=e.payments,f=e.satsPerKb,d=void 0===f?b:f,l=e.changeAddress,h=void 0===l?u.toAddress().toString():l,v=new i(d),m=new s,g=p(c);!(n=g()).done;){var y=n.value,w={satoshis:y.amount,lockingScript:(new t).lock(y.to)};m.addOutput(w)}var x=0n,S=m.outputs.reduce(function(t,e){return t+(e.satoshis||0)},0),k=0,O=function(t,e,r){if("function"==typeof t[H]){var n,o,i,s=t[H]();if(function t(a){try{for(;!((n=s.next()).done||r&&r());)if((a=e(n.value))&&a.then){if(!U(a))return void a.then(t,i||(i=L.bind(null,o=new K,2)));a=a.v}o?L(o,1,a):o=a}catch(t){L(o||(o=new K),2,t)}}(),s.return){var a=function(t){try{n.done||s.return()}catch(t){}return t};if(o&&o.then)return o.then(a,function(t){throw a(t)});a()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<t.length;c++)u.push(t[c]);return function(t,e,r){var n,o,i=-1;return function s(a){try{for(;++i<t.length&&(!r||!r());)if((a=e(i))&&a.then){if(!U(a))return void a.then(s,o||(o=L.bind(null,n=new K,2)));a=a.v}n?L(n,1,a):n=a}catch(t){L(n||(n=new K),2,t)}}(),n}(u,function(t){return e(u[t])},r)}(a,function(e){var n=P(e,(new t).unlock(u));return m.addInput(n),x+=BigInt(e.satoshis),Promise.resolve(v.computeFee(m)).then(function(t){x>=S+(k=t)&&(r=1)})},function(){return r});return Promise.resolve(O&&O.then?O.then(o):o())}catch(t){return Promise.reject(t)}},D=function(t){try{var e=t.protocol,r=t.tokenID,n=t.utxos,o=t.inputTokens,i=t.distributions,s=t.paymentPk,a=t.ordPk,u=t.changeAddress,c=t.tokenChangeAddress,f=t.satsPerKb,d=void 0===f?b:f,l=t.metaData,v=t.signer,g=t.additionalPayments,y=void 0===g?[]:g,w=t.burn,x=void 0!==w&&w,S=0n,P=0n,k=0n;if(!o.every(function(t){return t.id===r}))throw new Error("Input tokens do not match the provided tokenID");for(var O,I=p(o);!(O=I()).done;)P+=BigInt(O.value.amt);for(var B,A=p(i);!(B=A()).done;)k+=BigInt(B.value.amt);if(P<k)throw new Error("Not enough tokens to send");if((S=P-k)>0n){var E={address:c||a.toAddress().toString(),amt:S.toString()};i.push(E)}var j=i.map(function(t){var n,o={p:"bsv-20",op:x?"burn":"transfer",amt:t.amt};if(e===m.BSV20)n=h({},o,{tick:r});else{if(e!==m.BSV21)throw new Error("Invalid protocol");n=h({},o,{id:r})}return{address:t.address,inscription:{dataB64:Buffer.from(JSON.stringify(n)).toString("base64"),contentType:"application/bsv-20"}}}),C={paymentUtxos:n,ordinals:o,paymentPk:s,ordPk:a,destinations:j,changeAddress:u||s.toAddress().toString(),satsPerKb:d,metaData:l,signer:v,additionalPayments:y,enforceUniformSend:!1};return Promise.resolve(N(C)).then(function(t){var e,n=t.tx,o=t.spentOutpoints,i=t.payChange,s=j.findIndex(function(t){return t.address===(c||a.toAddress().toString())});return-1!==s&&(e={id:r,amt:S.toString(),satoshis:1,txid:n.id("hex"),vout:s,script:Buffer.from(n.outputs[s].lockingScript.toHex(),"hex").toString("base64")}),{tx:n,spentOutpoints:o,payChange:i,tokenChange:e}})}catch(t){return Promise.reject(t)}},F=function(t,e){try{if("collection"===t){var r=e;if(!r.description)return new Error("Collection description is required");if(!r.quantity)return new Error("Collection quantity is required");if(r.rarityLabels){if(!Array.isArray(r.rarityLabels))return new Error("Rarity labels must be an array");if(!r.rarityLabels.every(function(t){return Object.values(t).every(function(t){return"string"==typeof t})}))return new Error("Invalid rarity labels "+r.rarityLabels)}if(r.traits){if("object"!=typeof r.traits)return new Error("Collection traits must be an object");if(r.traits&&!Object.keys(r.traits).every(function(t){return"string"==typeof t&&"object"==typeof r.traits[t]}))return new Error("Collection traits must be a valid CollectionTraits object")}}if("collectionItem"===t){var n=e;if(!n.collectionId)return new Error("Collection id is required");if(!n.collectionId.includes("_"))return new Error("Collection id must be a valid outpoint");if(64!==n.collectionId.split("_")[0].length)return new Error("Collection id must contain a valid txid");if(Number.isNaN(Number.parseInt(n.collectionId.split("_")[1])))return new Error("Collection id must contain a valid vout");if(n.mintNumber&&"number"!=typeof n.mintNumber)return new Error("Mint number must be a number");if(n.rank&&"number"!=typeof n.rank)return new Error("Rank must be a number");if(n.rarityLabel&&"string"!=typeof n.rarityLabel)return new Error("Rarity label must be a string");if(n.traits&&"object"!=typeof n.traits)return new Error("Traits must be an object");if(n.attachments&&!Array.isArray(n.attachments))return new Error("Attachments must be an array")}return}catch(t){return new Error("Invalid JSON data")}},M=/*#__PURE__*/function(){function e(){}var o=e.prototype;return o.lock=function(o,i,s){var a=n.fromBase58Check(o).data,u=n.fromBase58Check(i).data;return r.fromHex("2097dfd76851bf465e8f715593b217714858bbe9570ff3bd5e33840a34e20ff0262102ba79df5f8ae7604a9830f03c7933028186aede0675a16f025dc4f8be8eec0382201008ce7480da41702918d1ec8e6849ba32b4d65b1e40dc669c31a1e6306b266c0000").writeBin(a).writeBin(e.buildOutput(s,(new t).lock(u).toBinary())).writeScript(r.fromHex("615179547a75537a537a537a0079537a75527a527a7575615579008763567901c161517957795779210ac407f0e4bd44bfc207355a778b046225a7068fc59ee7eda43ad905aadbffc800206c266b30e6a1319c66dc401e5bd6b432ba49688eecd118297041da8074ce081059795679615679aa0079610079517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e81517a75615779567956795679567961537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00517951796151795179970079009f63007952799367007968517a75517a75517a7561527a75517a517951795296a0630079527994527a75517a6853798277527982775379012080517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01205279947f7754537993527993013051797e527e54797e58797e527e53797e52797e57797e0079517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a756100795779ac517a75517a75517a75517a75517a75517a75517a75517a75517a7561517a75517a756169587951797e58797eaa577961007982775179517958947f7551790128947f77517a75517a75618777777777777777777767557951876351795779a9876957795779ac777777777777777767006868"))},o.cancelListing=function(e,r,n,o,i){void 0===r&&(r="all"),void 0===n&&(n=!1);var s=(new t).unlock(e,r,n,o,i);return{sign:function(t,e){try{return Promise.resolve(s.sign(t,e)).then(function(t){return t.writeOpCode(a.OP_1)})}catch(t){return Promise.reject(t)}},estimateLength:function(){return Promise.resolve(107)}}},o.purchaseListing=function(t,r){var o={sign:function(o,i){try{if(o.outputs.length<2)throw new Error("Malformed transaction");var s=(new c).writeBin(e.buildOutput(o.outputs[0].satoshis||0,o.outputs[0].lockingScript.toBinary()));if(o.outputs.length>2){for(var u,d=new n.Writer,l=p(o.outputs.slice(2));!(u=l()).done;){var h=u.value;d.write(e.buildOutput(h.satoshis||0,h.lockingScript.toBinary()))}s.writeBin(d.toArray())}else s.writeOpCode(a.OP_0);var v=o.inputs[i],m=f.format({sourceTXID:v.sourceTXID||v.sourceTransaction.id("hex"),sourceOutputIndex:v.sourceOutputIndex,sourceSatoshis:t||v.sourceTransaction.outputs[v.sourceOutputIndex].satoshis,transactionVersion:o.version,otherInputs:[],inputIndex:i,outputs:o.outputs,inputSequence:v.sequence,subscript:r||v.sourceTransaction.outputs[v.sourceOutputIndex].lockingScript,lockTime:o.lockTime,scope:f.SIGHASH_ALL|f.SIGHASH_ANYONECANPAY|f.SIGHASH_FORKID});return Promise.resolve(s.writeBin(m).writeOpCode(a.OP_0))}catch(t){return Promise.reject(t)}},estimateLength:function(t,e){try{return Promise.resolve(o.sign(t,e)).then(function(t){return t.toBinary().length})}catch(t){return Promise.reject(t)}}};return o},e.buildOutput=function(t,e){var r=new n.Writer;return r.writeUInt64LEBn(new u(t)),r.writeVarIntNum(e.length),r.write(e),r.toArray()},e}(),R=function(e){try{for(var r,n=e.utxos,o=e.listings,a=e.paymentPk,u=e.changeAddress,c=e.satsPerKb,f=e.additionalPayments,d=void 0===f?[]:f,l=new i(void 0===c?b:c),h=new s,v=p(n);!(r=v()).done;){var m=P(r.value,(new t).unlock(a));h.addInput(m)}o.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var g,y=p(o);!(g=y()).done;){var w=g.value;h.addOutput({satoshis:1,lockingScript:(new M).lock(w.payAddress,w.ordAddress,w.price)})}for(var x,S=p(d);!(x=S()).done;){var k=x.value;h.addOutput({satoshis:k.amount,lockingScript:(new t).lock(k.to)})}var O=n.reduce(function(t,e){return t+BigInt(e.satoshis)},0n),I=h.outputs.reduce(function(t,e){return t+BigInt(e.satoshis||0)},0n);return Promise.resolve(l.computeFee(h)).then(function(e){var r;if(O>I+BigInt(e)){var o=(new t).lock(u||a.toAddress().toString()),i={lockingScript:o,change:!0};r={txid:"",vout:h.outputs.length,satoshis:0,script:Buffer.from(o.toHex(),"hex").toString("base64")},h.addOutput(i)}return Promise.resolve(h.fee(l)).then(function(){return Promise.resolve(h.sign()).then(function(){return r&&(r.satoshis=h.outputs[h.outputs.length-1].satoshis,r.txid=h.id("hex")),{tx:h,spentOutpoints:n.map(function(t){return t.txid+"_"+t.vout}),payChange:r}})})})}catch(t){return Promise.reject(t)}},V=function(e){try{for(var n,o=e.utxos,a=e.listingUtxos,u=e.ordPk,c=e.paymentPk,f=e.changeAddress,d=e.satsPerKb,l=new i(void 0===d?b:d),h=new s,v=p(a);!(n=v()).done;){var m=n.value;h.addInput({unlockingScript:r.fromHex(Buffer.from(m.script,"base64").toString("hex")),unlockingScriptTemplate:(new M).cancelListing(u),sourceOutputIndex:m.vout,sequence:4294967295})}for(var g,y=p(o);!(g=y()).done;){var w=P(g.value,(new t).unlock(c));h.addInput(w)}a.length>100&&console.warn("Creating many inscriptions at once can be slow. Consider using multiple transactions instead.");for(var x=p(a);!x().done;)h.addOutput({satoshis:1,lockingScript:(new t).lock(u.toAddress().toString())});var S=o.reduce(function(t,e){return t+BigInt(e.satoshis)},0n),k=h.outputs.reduce(function(t,e){return t+BigInt(e.satoshis||0)},0n);return Promise.resolve(l.computeFee(h)).then(function(e){var r;if(S>k+BigInt(e)){var n=(new t).lock(f||c.toAddress().toString()),i={lockingScript:n,change:!0};r={txid:"",vout:h.outputs.length,satoshis:0,script:Buffer.from(n.toHex(),"hex").toString("base64")},h.addOutput(i)}return Promise.resolve(h.fee(l)).then(function(){return Promise.resolve(h.sign()).then(function(){return r&&(r.satoshis=h.outputs[h.outputs.length-1].satoshis,r.txid=h.id("hex")),{tx:h,spentOutpoints:o.map(function(t){return t.txid+"_"+t.vout}),payChange:r}})})})}catch(t){return Promise.reject(t)}},J=function(e){try{var n=e.utxos,o=e.paymentPk,a=e.listingUtxo,u=e.ordAddress,c=e.changeAddress,f=e.additionalPayments,d=void 0===f?[]:f,l=e.satsPerKb,h=new i(void 0===l?b:l),v=new s;v.addInput({unlockingScript:r.fromHex(Buffer.from(a.script,"base64").toString("hex")),unlockingScriptTemplate:(new M).purchaseListing(),sourceOutputIndex:a.vout,sequence:4294967295});for(var m,g=p(n);!(m=g()).done;){var y=P(m.value,(new t).unlock(o));v.addInput(y)}v.addOutput({satoshis:1,lockingScript:(new t).lock(u)});for(var w,x=p(d);!(w=x()).done;){var S=w.value;v.addOutput({satoshis:S.amount,lockingScript:(new t).lock(S.to)})}var k=n.reduce(function(t,e){return t+BigInt(e.satoshis)},0n),O=v.outputs.reduce(function(t,e){return t+BigInt(e.satoshis||0)},0n);return Promise.resolve(h.computeFee(v)).then(function(e){var r;if(k>O+BigInt(e)){var i=(new t).lock(c||o.toAddress().toString()),s={lockingScript:i,change:!0};r={txid:"",vout:v.outputs.length,satoshis:0,script:Buffer.from(i.toHex(),"hex").toString("base64")},v.addOutput(s)}return Promise.resolve(v.fee(h)).then(function(){return Promise.resolve(v.sign()).then(function(){return r&&(r.satoshis=v.outputs[v.outputs.length-1].satoshis,r.txid=v.id("hex")),{tx:v,spentOutpoints:n.map(function(t){return t.txid+"_"+t.vout}),payChange:r}})})})}catch(t){return Promise.reject(t)}};export{M as OrdLock,x as OrdP2PKH,g as RoytaltyType,m as TokenType,V as cancelOrdListings,R as createOrdListings,E as createOrdinals,O as fetchNftUtxos,k as fetchPayUtxos,I as fetchTokenUtxos,J as purchaseOrdListings,N as sendOrdinals,q as sendUtxos,A as stringifyMetaData,D as transferOrdTokens,F as validateSubTypeData};
//# sourceMappingURL=index.module.js.map
