import{Script as t,Transaction as o,TxIn as n,P2PKHAddress as s,TxOut as e,SigHash as r}from"bsv-wasm";import{Buffer as i}from"buffer";import c from"fs";import _ from"path";import a from"os";import{Sigma as l}from"sigma-protocol";const g=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function u(t){console.log(`[dotenv@16.0.3][DEBUG] ${t}`)}const p={config:function(t){let o=_.resolve(process.cwd(),".env"),n="utf8";const s=Boolean(t&&t.debug),e=Boolean(t&&t.override);var r;t&&(null!=t.path&&(o="~"===(r=t.path)[0]?_.join(a.homedir(),r.slice(1)):r),null!=t.encoding&&(n=t.encoding));try{const t=p.parse(c.readFileSync(o,{encoding:n}));return Object.keys(t).forEach(function(o){Object.prototype.hasOwnProperty.call(process.env,o)?(!0===e&&(process.env[o]=t[o]),s&&u(!0===e?`"${o}" is already defined in \`process.env\` and WAS overwritten`:`"${o}" is already defined in \`process.env\` and was NOT overwritten`)):process.env[o]=t[o]}),{parsed:t}}catch(t){return s&&u(`Failed to load ${o} ${t.message}`),{error:t}}},parse:function(t){const o={};let n,s=t.toString();for(s=s.replace(/\r\n?/gm,"\n");null!=(n=g.exec(s));){const t=n[1];let s=n[2]||"";s=s.trim();const e=s[0];s=s.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===e&&(s=s.replace(/\\n/g,"\n"),s=s.replace(/\\r/g,"\r")),o[t]=s}return o}};var f=p.config,d=p.parse,m=p;m.config=f,m.parse=d;const h=t=>i.from(t).toString("hex");f();const w=(o,n,s,e)=>{let r="";if(void 0!==n&&void 0!==s){const t=h("ord"),o=i.from(n,"base64").toString("hex");r=`OP_0 OP_IF ${t} OP_1 ${h(s)} OP_0 ${o} OP_ENDIF`}let c=`${o.get_locking_script().to_asm_string()}${r?" "+r:""}`;if(e&&null!=e&&e.app&&null!=e&&e.type){c=`${c} OP_RETURN ${h("1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5")} ${h("SET")}`;for(const[t,o]of Object.entries(e))"cmd"!==t&&(c=`${c} ${h(t)} ${h(o)}`)}return t.from_asm_string(c)},v=async(r,c,_,a)=>{let l=new o(1,0),g=new n(i.from(r.txid,"hex"),r.vout,t.from_asm_string(r.script));l.add_input(g);const u=w(s.from_string(c),null==_?void 0:_.dataB64,null==_?void 0:_.contentType,a);let p=new e(BigInt(1),u);return l.add_output(p),l},y=async(c,_,a,g,u,p,f,d,m=[])=>{let h=new o(1,0),v=new n(i.from(c.txid,"hex"),c.vout,t.from_asm_string(""));h.add_input(v);const y=w(s.from_string(_),p.dataB64,p.contentType,f);let $=new e(BigInt(1),y);h.add_output($);for(let t of m){let o=new e(t.amount,s.from_string(t.to).get_locking_script());h.add_output(o)}let x=0n,k=h.get_noutputs();for(const t of Array(k).keys()){var O;x+=(null==(O=h.get_output(t))?void 0:O.get_satoshis())||0n}const b=s.from_string(g).get_locking_script(),S=Math.ceil(u*(h.get_size()+B+I)),T=BigInt(c.satoshis)-x-BigInt(S);if(T<0)throw new Error("Inadequate satoshis for fee");if(T>0){let t=new e(BigInt(T),b);h.add_output(t)}const P=null==d?void 0:d.idKey,E=null==d?void 0:d.keyHost;if(P){const t=new l(h),{signedTx:o}=t.sign(P);h=o}else if(E){const t=null==d?void 0:d.authToken,o=new l(h);try{const{signedTx:n}=await o.remoteSign(E,t);h=n}catch(t){throw console.log(t),new Error("Remote signing to "+E+" failed")}}const F=h.sign(a,r.ALL|r.FORKID,0,t.from_asm_string(c.script),BigInt(c.satoshis));return v.set_unlocking_script(t.from_asm_string(`${F.to_hex()} ${a.to_public_key().to_hex()}`)),h.set_input(0,v),h},$=async(c,_,a,l,g,u,p,f,d,m=[])=>{let h=new o(1,0),v=new n(i.from(_.txid,"hex"),_.vout,t.from_asm_string(""));h.add_input(v);let y,$=new n(i.from(c.txid,"hex"),c.vout,t.from_asm_string(""));h.add_input($);const x=s.from_string(p);y=null!=f&&f.dataB64&&null!=f&&f.contentType?w(x,f.dataB64,f.contentType,d):x.get_locking_script();let k=new e(BigInt(1),y);h.add_output(k);for(let t of m){let o=new e(t.amount,s.from_string(t.to).get_locking_script());h.add_output(o)}let O=0n,b=h.get_noutputs();for(const t of Array(b).keys()){var S;O+=(null==(S=h.get_output(t))?void 0:S.get_satoshis())||0n}const T=s.from_string(l).get_locking_script(),P=Math.ceil(g*(h.get_size()+B+2*I)),E=BigInt(c.satoshis)-O-BigInt(P);let F=new e(E,T);h.add_output(F);const K=h.sign(u,r.InputOutput,0,t.from_asm_string(_.script),BigInt(_.satoshis));v.set_unlocking_script(t.from_asm_string(`${K.to_hex()} ${u.to_public_key().to_hex()}`)),h.set_input(0,v);const R=h.sign(a,r.InputOutput,1,t.from_asm_string(c.script),BigInt(c.satoshis));return $.set_unlocking_script(t.from_asm_string(`${R.to_hex()} ${a.to_public_key().to_hex()}`)),h.set_input(1,$),h},x=async(s,c,_,a)=>{const l=new o(1,0);let g=0;for(let t of s||[])g+=t.satoshis;const u=g-a;console.log({feeSats:a,satsIn:g,satsOut:u}),l.add_output(new e(BigInt(u),_.get_locking_script()));let p=0;for(let o of s||[]){console.log({u:o});const s=new n(i.from(o.txid,"hex"),o.vout,t.from_asm_string(""));console.log({inx:s}),s.set_satoshis(BigInt(o.satoshis)),l.add_input(s);const e=l.sign(c,r.InputOutputs,p,t.from_asm_string(o.script),BigInt(o.satoshis));s.set_unlocking_script(t.from_asm_string(`${e.to_hex()} ${c.to_public_key().to_hex()}`)),l.set_input(p,s),p++}return l},I=107,k=148,B=34;export{k as P2PKH_FULL_INPUT_SIZE,I as P2PKH_INPUT_SCRIPT_SIZE,B as P2PKH_OUTPUT_SIZE,w as buildInscription,v as buildReinscriptionTemplate,y as createOrdinal,$ as sendOrdinal,x as sendUtxos};
//# sourceMappingURL=index.modern.js.map
